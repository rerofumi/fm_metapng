# fm_metapng 開発記録

Feb.09.2025 - rerofumi

## 目的

簡単な CLI コマンドを rust で作成する。

その際、LLM 利用の AI 開発エージェントに頼り、できるだけそれらに与える自然言語プロンプトだけで進行させる。

### 作成する物

- StableDiffusion WebUI で生成した PNG 画像にはメタデータ部分に生成で使ったプロンプトが記録されている。
- コマンドに PNG のパスを渡すと、そのプロンプトを表示する小物ツールが欲しい。
- コード自体は 50行にも満たない内容だが、開発から公開までの手順を LLM エージェントにできるだけ頼るという課題にはちょうど良い。

## 前提

### 開発者

- 職業プログラマ
- rust はちょっとだけかじったことがある。数独の問題を総当たりで解くプログラムを rust で書いた。
- といっても数年前の話なのでほとんど忘れている。
- 全く知らない言語をエージェント任せで作る、というのはちょいと難易度が高いのでほとんど覚えていない言語にてエージェント任せで作る方が評価しやすい。

### 開発環境

- Windows11 & WSL2 (Debian)
- LLM エージェント
  - block/goose
    - WSL2/Debian GNU Linux 上の CLI で使用
    - developer extension 有効
    - 使用する LLM は google API の Gemini2.0-flash
  - VSCode + Coo CODE
    - goose で行き詰まったときに使用

## 製作記録

プロンプトメモをベースに、エージェントの行動自体は省略。

- `goose session` で作業開始

> prompt :
> 今回は rust で CLI ツールを作成します。プロジェクト名は "fm_metapng" です。まず cargo で fm_metapng のプロジェクトを作ってください。最初はテンプレートとして "hello, world!" を表示する main を作成し。起動したら "hello, world!" が表示されるところまで作ります。

- まずは無難にプロジェクト作成
- `cargo new <プロジェクト名>` で作られる main.rs に最初から "hello, world" が書いてあるので別に指示する必要無かった
- 起動指示を含めているので goose が `cargo run` まで実行し、コンソールに文字が表示されるまでテストとして確認してくれる
  - goose の development extension が有効じゃないとコマンド実行してくれないので注意
  - その場合 `cargo new` も実行されないか
- 起動してテスト、git に commit 等のアクションは 1回指示するとセッションの中では毎回実行し続ける様になる、便利だけれども毎回だと困る場面があったりする


> prompt :
> CLI ツールとして 1つ PNG ファイルのパスを受け取ります。main で ARG を 1つ受け取り、その値を表示して確認します。ARG が指定されていないときは help を表示して終了するようにしてください。

- ここからコードにプログラムの追加をしていく部分
- こういうコマンドライン引数の処理は地味に面倒なのでよしなにやってくれるのはありがたい
- もちろん起動して動作確認してくれる

> prompt :
> "fm_metapng/test/" の下にテスト用の PNG データを 1つ置きました。このファイルが git リポジトリに含まれないように .gitignore ファイルを編集して "test/" を追加してください。

- これも他愛もない操作なので問題無く実行、と思われたが `.gitignore` ファイルを新規作成したので前にあった設定は消えてしまいました
- ひょっとして通常の ls で確認していて `.gitignore` ファイルが見えていないな？なので新規で作りたがるんだろう 

> prompt :
> 今の操作で .gitignore ファイルにあった "target/" が消えてしまいました。target と test どちらの記載も必要です。

- 訂正を指示したら、その通りに更新してくれた

> prompt :
> arg で受け取ったファイルパスがpngを示しているので、このファイルを読み込んでファイル内のメタデータ ”parameters” を抽出して表示してください。"parameters" がない場合はその旨を伝えて終了します。テストには "test/" 内に既に置いてある png ファイルを"test/20250129-013449.png" を使用します。

- このツールの本体、今回のメイン。機能自体はこのプロンプトで十分作成してくれる
- test ファイルを指定せずディレクトリだけ指定したら、すっごい適当なテストデータを勝手に作って動きましたとか言ってきたので明確に指示を出している
- ここが一番の山場でもあって、今回実際に動くコードを作成してくれなかった
  - 原因は rust の png モジュールで、メタデータ操作関連がバージョンアップで細々と変化していた
  - LLM の知識ベースはちょいと前の物なので、その頃のリファレンスで実装して動かなかったという状況に陥った次第
- エージェント自身頑張って色々な方法を試すのだけれども、3回くらい試してこりゃダメだと png クレートを使うことを諦め、外部で `pnginfo` コマンドを使ってその結果を使う形に舵を切った(この挙動はちょっとビックリした)
  - さらにいうと `pnginfo` コマンドが無いので `sudo apt install pnginfo` で勝手にインストールを始めた
  - 流石にこの行動にはちょっと面食らったので goose での実行を止めて手で直すことに
- 1つの実行ファイルで済むバイナリが欲しくて rust で作っているのに外部コマンドを呼び出すとかもってのほかである、windows で動かなくなるのでやはり png クレートを使った形にしたい
- o3-mini に質問してみてもやはり動作しないコードを出力してきたので、ここの自動実装はあきらめ
- 今回、自身の rust 勉強も兼ねているのでここは手で実装した
- goose は同一セッションで行ったことは覚えているので、手作業で実装した後に次の指示をしても「pnginfo を呼び出す形で実装します」とかいって上書きして消してしまう。手で実装した後は、一旦止めて新規実装にしてしまった方が良い

> モリモリ手作業区間

> prompt :
> main.rs で ARGS を使ってパス名を受け取るのに "--path" オプションを使っていますが、これをオプション扱いではなく第一引数をパス名と見なすように書き換えてください。

- 基本動作が実装できた後のソースコード改変指示
- 手書きの後なので goose を起動し直して新規セッションになっている、これまでのあらすじみたいな口調になっているのはそのため
- こんくらいの指示なら特に問題無く改変してくれる

> prompt :
> "test/" 内に既に置いてある png ファイル "test/20250129-013449.png" を使用して動作確認してください。

- セッションが新しくなっていたので、動作確認も新たに指示し直し

> prompt :
> この変更に適切なコメントを付けて git commit してください

- コミットメッセージは勝手に付けて欲しいし、その夢が叶った
- ここでコミットを指示すると、この後の与える指示の度にコミットするようになる、便利なようなやっかいなような

> prompt :
> main という名の git ブランチ名を作成しそちらに移行してください

- これくらいだと日本語で指示を出すより自分でコマンドを入れた方が早い
- でも git 操作でも問題無いことを確認したいので敢えて

> prompt :
> git リポジトリの remote に git@github.com:rerofumi/fm_metapng.git を設定してこれを origin としてください

- このへんそらで覚えて無くて調べる事があるラインの操作は楽に感じる

> prompt :
> やはりgitリポジトリのoriginはhttp://192.168.0.120:33000/rerofumi/fm_metapng.git にします git@github.com:rerofumi/fm_metapng.git はgithub という名前のremoteとして設定してください

- 192.168.0.120 は LAN 環境に立てている gitea サーバー
- そっちに優先して push して、纏まったところで github に push する形にした

> remote github に push github main してください

- この辺も直接コマンド入れた方が早い作業

> prompt :
> github で公開するために github 準拠な README.md を作成してください。このリポジトリは PNG の中に書かれている生成AIで生成したときのプロンプトを表示するツールです。その他機能や引数等は main.rs の中身を参照して書き出します。release からは Windows と Linux のビルド済み実行ファイルがダウンロードできることをアピールしてください。

- LLM エージェント開発の真骨頂はドキュメント作成だと思う
- ソースコードをみてオプションの説明書いてください、ってのがほんと楽で嬉しい
- それでできた README.md が今ある奴なんだけど、色々気に入らないところがあるので手直ししたい

> prompt :
> github actions を使って、このリポジトリの main ブランチが更新されたときに自動ビルドが走る環境を構築してください。ターゲットは "intel x86_64 Linux" と "intel x86_64 Windows" でお願いします。ビルドが完了したアーティファクトは upload-release-asset を使って release に公開します。

- これもできたら強い、んだけどちゃんと動く設定は出てこなかった。残念。
- push しないとエラーコードにたどり着けないし、github のコンソールをみないといけないしで、ここを自動で完成させるのは諦め
- 出力された設定ファイルをベースに手で書いていくこととなった

> prompt :
> github actions の設定が matrix になっているので意図せず 4つのビルドとなっています。"ubuntu-latest, x86_64-unknown-linux-gnu", "windows-latest, x86_64-pc-windows-msvc" の2つになるよう変更してください

- こういった細かい指示の改変はできる
- 結局 github actions の設定は難儀しながら、手作業で完成させた

> モリモリ手作業区間


> prompt :
> main.rs に機能を追加してください。この CLI コマンドは結果をコンソールに表示したらすぐに exit してしまいますが、exit する前にユーザーからの何らかのコンソール入力を待つようにしてください。ユーザーが enter を押したら exit します。コマンドラインオプションに "-n, --no-pause" を追加し、これが指定されていたらユーザー入力を待たずに exit させます。

- コマンド完成後、初の機能拡充作業
- この辺は仕様の指示がしやすいので、結果も良い感じで上がってくる
- 追加はうまくいったけれどもソースコード中の '\n' が改行に変換されてしまったのでそこは手で修正

> prompt :
> README.md, README_en.md それぞれに  "-n, --no-pause" についての説明を追加してください。

- ドキュメント更新もエージェントで楽々、を夢見ていたのですが goose が止まってしまって続行不可能
- ひょっとして日本語文字列に弱い？
- やむを得ないのでドキュメント更新は VSCode 上で ROO CODE(ROO Cline) で処理

> prompt for roo code:
> コマンド実行後にユーザーからのenter入力を待つ機能が追加されました。"-n, --no-pause" オプションでその入力待ちをスキップできます。README.md, README_en.md それぞれに enter 待ちをする仕様についてと "-n, --no-pause" オプションについての説明を追加してください。

> prompt for roo code:
> Enter 入力待ち機能は新機能なのでバージョンを v0.2.0 に引き上げます。cargo.toml に記載してください。また更新履歴を README.md, README_en.md それぞれに記載します

- ドキュメント更新が任せられるのはやっぱ楽


## 所感

そんなこんなで完成。
コードだけならともかく CI やリリースなど周辺もエージェントで生成してみた次第。

やっぱ任せっぱなしにはできないので、都度コードレビュー＆手直しは必要だなという当たり前の感想を抱く形となった。楽になる部分は確実にあるので使い処と使いこなしですな、と毒にも薬にもならない言葉で締めつつ今回はおしまい。
